datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum VISIBILITY_CHOICE {
  PUBLIC
  PRIVATE
  UNLISTED
}

enum ROTATION_CHOICE {
  DAILY
  WEEKLY
  MONTHLY
  ANNUALLY
  CUSTOM
}

enum ROTATION_TYPE {
  DAILY
  WEEKLY
  ANNUALLY
}

enum STATUS_CHOICE {
  ONGOING
  PENDING
  COMPLETE
}

enum TURN_STATUS_CHOICE {
  PENDING
  DONE
}

model Hub {
  id            Int               @id @default(autoincrement())
  uuid          String            @unique @default(uuid())
  name          String            @db.VarChar(256)
  logo          String?           @db.VarChar(400)
  theme         String?           @db.VarChar(50)
  visibility    VISIBILITY_CHOICE @default(PUBLIC)
  description   String?           @default("")
  ownerId       String?
  slug          String            @unique @db.VarChar(256)
  rosters       Roster[]
  members       HubMembership[]
  activities    Activity[]
  notifications Notification[]
  invitesSent   Invite[]
  isDeleted     Boolean           @default(false)
}

model HubMembership {
  uuid       String    @unique @default(uuid())
  hubUserid  Int
  hub        Hub       @relation(references: [id], fields: [hubId], onDelete: Cascade)
  hubId      Int
  dateJoined DateTime  @default(now()) @db.Timestamptz(3)
  isAdmin    Boolean   @default(false)
  isDeleted  Boolean   @default(false)
  dateLeft   DateTime? @db.Timestamptz(3)

  @@id([hubId, hubUserid])
}

model Roster {
  id                      Int                @id @default(autoincrement())
  uuid                    String             @unique @default(uuid())
  name                    String             @db.VarChar(256)
  description             String?            @default("")
  isPrivate               Boolean            @default(false)
  enablePushNotifications Boolean            @default(true)
  start                   DateTime           @db.Timestamptz(3)
  end                     DateTime           @db.Timestamptz(3)
  rotationType            ROTATION_CHOICE?
  hub                     Hub                @relation(references: [id], fields: [hubId], onDelete: Cascade)
  hubId                   Int
  createdById             String?
  currentTurnId           String?
  nextTurnId              String?
  nextDate                DateTime?          @db.Timestamptz(3)
  status                  STATUS_CHOICE      @default(PENDING)
  members                 RosterMembership[]
  comments                Comment[]
  turns                   Turn[]
  activities              Activity[]
  notifications           Notification[]
  invitesSent             Invite[]
  isDeleted               Boolean            @default(false)
  rotationOption          RotationOption?
}

model RosterMembership {
  uuid         String   @unique @default(uuid())
  rosterUserId String
  roster       Roster   @relation(references: [id], fields: [rosterId], onDelete: Cascade)
  rosterId     Int
  dateJoined   DateTime @default(now()) @db.Timestamptz(3)
  position     Int
  turn         Turn[]
  isAdmin      Boolean  @default(false)
  isDeleted    Boolean  @default(false)

  @@id([rosterId, rosterUserId])
}

model Activity {
  id        Int      @id @default(autoincrement())
  title     String   @db.VarChar(256)
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  meta      Json?
  actorId   String?
  body      String?  @default("")
  hub       Hub?     @relation(references: [id], fields: [hubId], onDelete: SetNull)
  hubId     Int?
  roster    Roster?  @relation(references: [id], fields: [rosterId], onDelete: SetNull)
  rosterId  Int?
  isDeleted Boolean  @default(false)
}

model Comment {
  id        Int      @id @default(autoincrement())
  uuid      String   @unique @default(uuid())
  userId    String?
  content   String   @default("")
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  roster    Roster?  @relation(references: [id], fields: [rosterId], onDelete: SetNull)
  rosterId  Int?
  isDeleted Boolean  @default(false)
}

model Notification {
  id        Int      @id @default(autoincrement())
  uuid      String   @unique @default(uuid())
  users     String[]
  body      String?  @default("")
  email     String?
  meta      Json?
  createdAt DateTime @default(now()) @db.Timestamptz(3)
  roster    Roster?  @relation(references: [id], fields: [rosterId], onDelete: SetNull)
  rosterId  Int?
  hub       Hub?     @relation(references: [id], fields: [hubId], onDelete: SetNull)
  hubId     Int?
  invite    Invite?  @relation(references: [id], fields: [inviteId], onDelete: SetNull)
  inviteId  Int?     @unique
  isDeleted Boolean  @default(false)
  turn      Turn?    @relation(references: [id], fields: [turnId], onDelete: SetNull)
  turnId    Int?
}

model Turn {
  id                           Int                @id @default(autoincrement())
  uuid                         String             @unique @default(uuid())
  status                       TURN_STATUS_CHOICE @default(PENDING)
  roster                       Roster?            @relation(references: [id], fields: [rosterId], onDelete: SetNull)
  rosterId                     Int?
  dueDate                      DateTime?          @db.Timestamptz(3)
  event                        Json?
  rosterMembership             RosterMembership?  @relation(fields: [rosterMembershipRosterId, rosterMembershipRosterUserId], references: [rosterId, rosterUserId])
  rosterMembershipRosterId     Int?
  rosterMembershipRosterUserId String?
  isDeleted                    Boolean            @default(false)
  notifications                Notification[]
}

model Invite {
  id           Int           @id @default(autoincrement())
  uuid         String        @unique @default(uuid())
  createdAt    DateTime      @default(now()) @db.Timestamptz(3)
  notification Notification?
  status       STATUS_CHOICE @default(PENDING)
  fromId       String?
  recipientId  String?
  email        String
  hub          Hub?          @relation(references: [id], fields: [hubId], onDelete: SetNull)
  hubId        Int?
  roster       Roster?       @relation(references: [id], fields: [rosterId], onDelete: SetNull)
  rosterId     Int?
  isDeleted    Boolean       @default(false)
}

model RotationOption {
  id       Int           @id @default(autoincrement())
  roster   Roster        @relation(references: [id], fields: [rosterId])
  rosterId Int           @unique
  rotation ROTATION_TYPE
  unit     Int
}
